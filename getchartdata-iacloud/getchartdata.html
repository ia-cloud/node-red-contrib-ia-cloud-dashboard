<script type="text/javascript">
    RED.nodes.registerType('getchartdata',{
        category: "iaCloud dashboard",
        color: "#ffd700",
        defaults: {
			name: {value:""},
			tableName: {value: "", required:true},
            // confsel: {value:"rawData"},
			objectKey: {value: "", required:true},
			// series: {value: "", required:true},
			seriesObject:{value:"", required: true },
			stime: {value: ""},
			etime: {value: ""},
			aggregationCheck: {value: false},
			aggregation: {value: "max"},
			aggreunit: {value: "year"},
			decimalPoint: {value: "0"},
			sort: {value: "true"},
			limit: {value: ""}
		},
		credentials: {
			userID: {type:"text", required:true},
            password: {type: "password", required:true}
		},
        inputs:1,
        outputs:1,
		icon: "ia-cloud.png", 
		paletteLabel: 'getChartdata',
        label: function() {
            return this.name || "getChartdata";
        },
        oneditprepare: function () {

			$("#node-input-aggregationCheck").change(function() {
                if ($(this).is(":checked")) {
					$(".node-input-aggregation-row").show();
					$("#node-row-SortSet").hide();
					$("#node-input-aggregationCheck").prop("checked", true);
                } else {
					$(".node-input-aggregation-row").hide();
					$("#node-row-SortSet").show();
					$("#node-input-aggregationCheck").prop("checked", false);
                }
			});
			
			var frm_cnt = 0;
            
            //あれば設定データを取り出して、formに展開する。
            var conf = $("#node-input-seriesObject").val();
            if (conf) {
				var dItems = {};
				try { dItems = JSON.parse(conf); }
				catch(e) { conf = "";}
            }
            if(conf != ""){
				//設定データがあった
				var dItems = JSON.parse(conf);
				//フォームを一つ保存
				var original = $('#form_block\\[0\\]');
				//一旦フォームオブジェクトをすべて削除
				$(".form-block[id^='form_block']")
					.each(function(index, formObj) {$(formObj).remove();});
				dItems.forEach(function(value, idx){
					original
					.clone()
					.hide()
					.appendTo("#blocks")
					.attr('id', 'form_block[' + idx + ']') // クローンのid属性を変更。
					.end() // 一度適用する
					.find('div, input, textarea, select, label').each(function(index, obj) {
						if ($(obj).attr('id') != null) {
							if($(obj).attr("id").substr(0,5) == "dItem"){
								$(obj).val("" + (idx + 1));
							}
							$(obj).attr({
							id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
							});
						}
						if ($(obj).attr('name') != null) {
							$(obj).attr({
								name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + idx + ']')
							});
						}
						if ($(obj).attr('for') != null) {
							$(obj).attr({
								for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
							});
						}
					});

					$("#dataName\\[" + idx + "\\]").val(value.dataName);
					$("#displayName\\[" + idx + "\\]").val(value.displayName);

					var block = $('#form_block\\[' + idx + '\\]');
					if (idx != 0) block.find('input[name="del_btn"]').show();
					block.slideDown('slow');
					frm_cnt = idx;
				});
        	}

			



			//追加ボタンが押されたら
			$("#form_add").off("click");
			$("#form_add").on("click", function() {
				var original = $('#form_block\\[' + frm_cnt + '\\]');
				frm_cnt++;
				original
				.clone()
				.hide()
				.insertAfter(original)
				.attr('id', 'form_block[' + frm_cnt + ']'); // クローンのid属性を変更。
				var clone = $('#form_block\\[' + frm_cnt + '\\]');
				clone.find('div, input, textarea, select, label').each(function(idx, obj) {
					if ($(obj).attr('id') != null) {
						if($(obj).attr("id").substr(0,5) == "dItem"){
							$(obj).val("" + (frm_cnt + 1));
						}
						$(obj).attr({
							id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
						});
						}
						if ($(obj).attr('name') != null) {
						$(obj).attr({
							name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
						});
						}
						if ($(obj).attr('for') != null) {
						$(obj).attr({
							for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
						});
					}
				});
				clone.find('input[name="del_btn"]').show();
				clone.slideDown('fast');
				});

				//削除ボタンが押されたら
				$("#blocks").off('click', 'input[name="del_btn"]');
				$("#blocks").on('click', 'input[name="del_btn"]', function() {
				var removeObj = $(this).parents(".form-block");
				removeObj.fadeOut('fast', function() {
					removeObj.remove();
					// 番号振り直し
					frm_cnt = 0;
					$(".form-block[id^='form_block']").each(function(index, formObj) {
						if ($(formObj).attr('id') != 'form_block[0]') {
							frm_cnt++;
							$(formObj)
							.attr('id', 'form_block[' + frm_cnt + ']') // id属性を変更。
							.find('div, input, textarea, select, label').each(function(idx, obj) {
							if ($(obj).attr('id') != null) {
								if($(obj).attr("id").substr(0,5) == "dItem"){
										$(obj).val("" + (frm_cnt + 1));
								}
								$(obj).attr({
									id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
								});
								}
								if ($(obj).attr('name') != null) {
								$(obj).attr({
									name: $(obj).attr('name').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
								});
								}
								if ($(obj).attr('for') != null) {
								$(obj).attr({
									for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
								});
								}
							});
						}
					});
				});
			});

		},
		oneditsave: function() {

			var dItems = [];

			$(".form-block[id^='form_block']").each(function(idx, obj){
				// var item ={commonName: "Alarm&Event", dataValue: {}, options:{}};
				var item = {};

				item.dataName = $("#dataName\\[" + idx + "\\]").val();
				item.displayName = $("#displayName\\[" + idx + "\\]").val();
				
				dItems[idx]=item;
			});

			//フォームの各要素をobjectに記述し、JSON文字列に変換する。
			try {$("#node-input-seriesObject").val(JSON.stringify(dItems));}
			catch(e) {$("#node-input-seriesObject").val("")}

			}
		});
</script>

<!-- ノード編集画面テンプレート -->
<script type="text/x-red" data-template-name="getchartdata">
    <!-- ノード名 -->
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> ノード名</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <hr/>

    <!-- 項目設定
    <label style="width: 100%;" for="node-input-format" ><i class="fa fa-list"></i>  入力値</label>
    <div class="form-row" style="margin-left: 100px">
        <input type="text" style="display: none; vertical-align: top;" id="node-input-confsel" valie="rawData">
        <input type="radio" style="display: inline-block; width: auto;  vertical-align: top;"
              name="configSel" id="node-input-configSel1"
              value="rowData" checked="checked">
        <label style="width: 30%; vertical-align: top;" for="node-input-configSel1"> 生データ</label>
        <input type="radio" style="display: inline-block; width: auto;  vertical-align: top;"
              name="configSel" id="node-input-configSel2" value="aggreData">
        <label style="width: 50%;" for="node-input-configSel2"> アグリゲーションデータ</label>
	</div>
	-->

	<!-- ユーザID -->
	<div class="form-row">
		<label for="node-input-userID"><i class="fa fa-tag"></i> 接続用ID<span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-userID" placeholder="userID"></input>
	</div>

	<!-- パスワード -->
	<div class="form-row">
		<label for="node-input-password"><i class="fa fa-key"></i> パスワード<span style="color: #ff0000;">*</span></label>
		<input type="password" id="node-input-password" placeholder="password"></input>
	</div>
	<hr/>

	<!-- テーブル名 -->
	<div class="form-row">
		<label for="node-input-tableName"><i class="fa fa-tag"></i> テーブル名<span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-tableName" placeholder="tableName"></input>
	</div>

	<!-- オブジェクトキー -->
	<div class="form-row">
		<label for="node-input-objectKey"><i class="fa fa-key"></i> オブジェクトキー<span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-objectKey" placeholder="objectKey"></input>
	</div>

	<!-- 項目名(dataName)
    <div class="form-row">
        <label for="node-input-series"><i class="fa fa-list"></i> 項目名(dataName)<span style="color: #ff0000;">*</span></label>
        <input type="text" id="node-input-series" placeholder="温度A,温度B,温度C">
	</div>
	-->

	<!-- 項目名(dataName)と表示名 -->
	<div class="form-row hidden">
		<input type="text" id="node-input-seriesObject">
	</div>
	<div class="form-row">
		<label for="node-input-series"><i class="fa fa-list"></i> 項目名<span style="color: #ff0000;">*</span></label>
	</div>
	<div id="blocks" style="margin-left: 10px">
		<div class="form-block" id="form_block[0]">
			<div class="form-row">
				<div class="form-inline" id="from_del[0]" >
					<span style="border-bottom:solid 2px;"><i class="fa fa-angle-right"></i> 項目番号</label></span>
					<input type="text" id="dItem[0]" style="width: 30px;" value="1"
						disabled="disabled">
					<input type="button" name="del_btn" value="削除"
						style="margin-left: 30px; width: 70px; display: none;">
				</div>
			</div>
			<div class="form-row" style="margin-left: 15px">
					<!-- <label for="node-input-dataName"><i class="fa fa-angle-right"></i> 指定値</label> -->
				dataName：
					<input type="text" style="width:120px;" id="dataName[0]">
				<!-- <label for="node-input-displayName"><i class="fa fa-angle-right"></i> 状態名</label> -->
				　表示名：
				<input type="text" style="width: 120px;" id="displayName[0]">
			</div>
			<br>
		</div>
	</div>

	<!-- Addボタン -->
	<div class="form-block">
		<input type="button" id="form_add" name="add_btn" value="追加">
	</div>

	<!-- アグリゲーション -->
	<hr/>
	<div class="form-row" style="width:450px;">
		<label for="node-input-aggregation"><i class="fa fa-calculator"></i> アグリゲーション</label>
		<input type="checkbox" id="node-input-aggregationCheck" style="display: inline-block; width: 20px; vertical-align: middle;>
		<label for="node-input-aggregationCheck" style="width: 40%; vertical-align: middle;">設定</label>

		<div style="margin-left: 20px" class="node-input-aggregation-row hide">
			<div class="form-row" style="margin-left: 100px">
				<select type="text" id="node-input-aggregation" style="width:150px;">
					<option value="max">最大値</option>
					<option value="min">最小値</option>
					<option value="average">平均</option>
					<option value="median">中央値</option>
					<option value="count">カウント</option>
					<option value="integration">積算</option>
					<option value="first">最初</option>
					<option value="last">最後</option>
				</select>
			</div>
			<div class="form-row" style="margin-left: 100px">
				単位
				<select type="text" id="node-input-aggreunit" style="width:60px;">
					<option value="year">年</option>
					<option value="month">月</option>
					<option value="week">週</option>
					<option value="day">日</option>
					<option value="hour">時</option>
					<option value="minute">分</option>
					<option value="second">秒</option>
				</select>
				　表示桁数
				<select type="text" id="node-input-decimalPoint" style="width:120px;">
					<option value="3">小数第3位</option>
					<option value="2">小数第2位</option>
					<option value="1">小数第1位</option>
					<option value="0">整数</option>
					<option value="-1">1の位</option>
					<option value="-2">10の位</option>
					<option value="-3">100の位</option>
				</select>
			</div>
		</div>
	</div>

	<!-- データ件数 -->
	<div class="form-row">
		<label for="node-input-limit"><i class="fa fa-clone"></i> データ件数</label>
		<input type="text" style="width:130px;" id="node-input-limit" placeholder="100"></input>
	</div>

	<!-- 期間 -->
	<div class="form-row">
		<label for="node-input-time"><i class="fa fa-calendar"></i> 期間</label>
		<input type="date" style="width:150px;" id="node-input-stime" placeholder="2018-01-01"></input>
		～
		<input type="date" style="width:150px;" id="node-input-etime" placeholder="2018-01-03"></input>
	</div>

	<div class="form-group hide"  id="node-row-SortSet">
		<!-- アグリゲーション未使用で使用可能 -->
		<!-- ソート -->
		<div class="form-row">
			<label for="node-input-sort"><i class="fa fa-sort"></i> 並び順</label>
			<select type="text" style="width:80px;" id="node-input-sort">
				<option value="true">昇順</option>
				<option value="false">降順</option>
			</select>
		</div>
	</div>
</script>

<!-- エディタに登録するノード説明 -->
<script type="text/x-red" data-help-name="getchartdata">
    <p>このノードはiacloudオブジェクト（json形式）をdashborad - chartへ入力する際の形へ変換することができます。</p>
    <h3>入力メッセージ</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>iacloudオブジェクト（json形式）。</dd>
    </dl>
    <h3>出力メッセージ</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>入力されたiacloudオブジェクトをdashborad - chartへ入力する際の形に変換した結果（json形式）。</dd>
    </dl>
    <h3>詳細説明</h3>
    <p>このノードは「ノード：<a href="https://github.com/ia-cloud/node-red-contrib-ia-cloud-output/tree/master/dynamodb-iacloud">node-red-contrib-dynamodb-iacloud</a>」
        からの出力を直接本ノードに入力して使用することができます。
    <p>直接変換対象データを入力する場合は、以下プロパティを設定する必要があります。</p>
    <ul>
        <li><code>項目名</code> - (文字列)出力する項目名(dataName)をカンマ区切りで入力する</li>
    </ul>
</script>