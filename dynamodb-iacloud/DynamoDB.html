<script type="text/javascript">
	RED.nodes.registerType('DynamoDB',{
		category: 'iaCloud dashboard',
		color:"#ffd700",
		defaults: {
			// aws: {type:"amazon config",required:true},
			name: {value: ""},
			tableName: {value: "", required:true},
			// userID: {value: "", required:true},
			// password: {value: "", required:true},
			operation: {value: "Query" },
			objectKey: {value: "", required:true},
			stime: {value: ""},
			etime: {value: ""},
			aggregationCheck: {value: false},
			aggregation: {value: "max"},
			aggreunit: {value: "year"},
			decimalPoint: {value: "0"},
			sort: {value: "true"},
			limit: {value: ""},
			Item: { value: ""}
		},
		credentials: {
			userID: {type:"text", required:true},
            password: {type: "password", required:true}
		},
		inputs:1,
		outputs:1,
		icon: "ia-cloud.png",
		align: "right",
		label: function() {
			return this.name || "DynamoDB " + this.operation;
		},
		oneditprepare: function () {

			// $('input[name="operation"]:select').change(function() {
			$('#node-input-operation').change(function() {
				if ($('#node-input-operation').val() == "Query") {			// Queryの場合
					$("#node-row-ScanQuerySet").show();
					$("#node-row-QuerySet").show();
					$("#node-row-PutItemSet").hide();
					
					if ($("#node-input-aggregationCheck").prop("checked")) {
						// アグリゲーション設定がONだったら非表示
						$("#node-row-QuerySortSet").hide();
					} else {
						// アグリゲーション設定がOFFだったら表示
						$("#node-row-QuerySortSet").show();
					}

				} else if ($('#node-input-operation').val() == "Scan") {	// Scanの場合
					$("#node-row-ScanQuerySet").show();
					$("#node-row-QuerySet").hide();
					$("#node-row-QuerySortSet").hide();
					$("#node-row-PutItemSet").hide();
				} else if ($('#node-input-operation').val() == "PutItem") {		// PutItemの場合
					$("#node-row-ScanQuerySet").hide();
					$("#node-row-QuerySet").hide();
					$("#node-row-QuerySortSet").hide();
					$("#node-row-PutItemSet").show();
				}
			});


			$("#node-input-aggregationCheck").change(function() {
                if ($(this).is(":checked")) {
					$(".node-input-aggregation-row").show();
					$("#node-row-QuerySortSet").hide();
					$("#node-input-aggregationCheck").prop("checked", true);
                } else {
					$(".node-input-aggregation-row").hide();
					$("#node-row-QuerySortSet").show();
					$("#node-input-aggregationCheck").prop("checked", false);
                }
            });

		}
	
	});
</script>

<script type="text/x-red" data-template-name="DynamoDB">
		<style scoped>
				.hiddenAttrs {display:none;}
				.visibleAttrs {display:block;}
		</style>

	<!-- AWSアカウント情報 
	<div class="form-row">
		<label for="node-input-aws"><i class="fa fa-user"></i> AWS</label>
		<input type="text" id="node-input-aws">
	</div>
	<hr/>
	-->

	<!-- ノード名 -->
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-user"></i> ノード名</label>
		<input type="text" id="node-input-name" placeholder="Name"></input>
	</div>
	<hr/>

	<!-- ユーザID -->
	<div class="form-row">
		<label for="node-input-userID"><i class="fa fa-tag"></i> 接続用ID<span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-userID" placeholder="userID"></input>
	</div>

	<!-- パスワード -->
	<div class="form-row">
		<label for="node-input-password"><i class="fa fa-key"></i> パスワード<span style="color: #ff0000;">*</span></label>
		<input type="password" id="node-input-password" placeholder="password"></input>
	</div>
	<hr/>

	<!-- テーブル名 -->
	<div class="form-row">
		<label for="node-input-tableName"><i class="fa fa-tag"></i> テーブル名<span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-tableName" placeholder="tableName"></input>
	</div>

	<!-- 機能 -->
	<div class="form-row">
		<label for="node-input-operation"><i class="fa fa-search"></i> 機能</label>
		<select type="text" id="node-input-operation">
			<option value="Query">Query</option>
			<option value="Scan">Scan</option>
			<option value="PutItem">PutItem</option>
		</select>
	</div>

	<!-- オブジェクトキー -->
	<div class="form-row">
		<label for="node-input-objectKey"><i class="fa fa-key"></i> オブジェクトキー<span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-objectKey" placeholder="objectKey"></input>
	</div>


	<div class="form-group hide"  id="node-row-ScanQuerySet">
		<!-- Scan・Queryで使用可能 -->
		<!-- アグリゲーション -->
		<div class="form-row" style="width:450px;">
			<label for="node-input-aggregation"><i class="fa fa-calculator"></i> アグリゲーション</label>
			<input type="checkbox" id="node-input-aggregationCheck" style="display: inline-block; width: 20px; vertical-align: middle;>
			<label for="node-input-aggregationCheck" style="width: 40%; vertical-align: middle;">設定</label>
			

			<div style="margin-left: 20px" class="node-input-aggregation-row hide">
				<div class="form-row" style="margin-left: 100px">
					<select type="text" id="node-input-aggregation" style="width:150px;">
						<option value="max">最大値</option>
						<option value="min">最小値</option>
						<option value="average">平均</option>
						<option value="median">中央値</option>
						<option value="count">カウント</option>
						<!-- <option value="integration">積算</option> -->
						<option value="first">最初</option>
						<option value="last">最後</option>
					</select>
				</div>
				<div class="form-row" style="margin-left: 100px">
					単位
					<select type="text" id="node-input-aggreunit" style="width:60px;">
						<option value="year">年</option>
						<option value="month">月</option>
						<option value="week">週</option>
						<option value="day">日</option>
						<option value="hour">時</option>
						<option value="minute">分</option>
						<option value="second">秒</option>
					</select>
					　表示桁数
					<select type="text" id="node-input-decimalPoint" style="width:120px;">
						<option value="3">小数第3位</option>
						<option value="2">小数第2位</option>
						<option value="1">小数第1位</option>
						<option value="0">整数</option>
						<option value="-1">1の位</option>
						<option value="-2">10の位</option>
						<option value="-3">100の位</option>
					</select>
				</div>
			</div>
		</div>





		<!-- Scan・Queryで使用可能 -->
		<!-- データ件数 -->
		<div class="form-row">
			<label for="node-input-limit"><i class="fa fa-clone"></i> データ件数</label>
			<input type="text" style="width:130px;" id="node-input-limit" placeholder="100"></input>
		</div>
	</div>


	<div class="form-group hide"  id="node-row-QuerySet">
		<!-- Queryで使用可能 -->
		<!-- 期間 -->
		<div class="form-row">
			<label for="node-input-time"><i class="fa fa-calendar"></i> 期間</label>
			<input type="date" style="width:150px;" id="node-input-stime" placeholder="2018-01-01"></input>
			～
			<input type="date" style="width:150px;" id="node-input-etime" placeholder="2018-01-03"></input>
		</div>
	</div>

	<div class="form-group hide"  id="node-row-QuerySortSet">
		<!-- Query・アグリゲーション未使用で使用可能 -->
		<!-- ソート -->
		<div class="form-row">
			<label for="node-input-sort"><i class="fa fa-sort"></i> 並び順</label>
			<select type="text" style="width:80px;" id="node-input-sort">
				<option value="true">昇順</option>
				<option value="false">降順</option>
			</select>
		</div>
	</div>




	<!-- PutItemで使用可能 -->
	<!-- Item設定 -->
	<!-- 
	<div id="AttrHolder">
		<div class="form-row" id='itemAttr' class='hiddenAttrs'>
			<label for="node-input-item"><i class="fa fa-tag"></i>item</label>
			<input type="text" id="node-input-item" placeholder="item"></input>
		</div> 
	</div>
	-->
	<div class="form-group hide"  id="node-row-PutItemSet">
		<div class="form-row">
			<label for="node-input-item"><i class="fa fa-tag"></i>item</label>
			<input type="text" id="node-input-item" placeholder="item"></input>
		</div> 
	</div>
	

 <script>
	  var nodeOps={

				Query:[
					'#tableName'
					],
				Scan:[
					'#tableName'
					],
				PutItem:[
					'#tableName','#itemAttr'
					]
		};
		$('#node-input-operation').on('change',function(){
			$('#AttrHolder').children().addClass('hiddenAttrs').removeClass('visibleAttrs');
				if (nodeOps[this.value])
					$(nodeOps[this.value].join()).addClass('visibleAttrs').removeClass('hiddenAttrs');
		 });

</script>

<script type="text/x-red" data-help-name="DynamoDB">
	<p>AWS-SDKでDynamoDB関数をラップするノードのセット。
	このノードはscan, query, put関数のみを使用できます。</p>
	<h3>出力メッセージ</h3>
	<dl class="message-properties">
		<dt>payload <span class="property-type">object</span></dt>
		<dd>各操作によって取得したオブジェクト。配列Itemsに格納された状態で返却されます。</dd>
	</dl>
	<h3>詳細説明</h3>
	<p>本ノードはJavascript APIをラップしたものです。より詳細に知るには、<a href="https://docs.aws.amazon.com/sdkforruby/api/Aws/DynamoDB/Client.html">APIドキュメント</a>を参照してください。</p>
	<p><b>注</b>:使用しているAWS IAMユーザが使用する機能に十分な権限を持っていることを確認してください。
		十分な権限を権限を持っていない場合、エラーメッセージが表示されます。</p>
</script>



