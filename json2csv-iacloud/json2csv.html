<script type="text/javascript">
    RED.nodes.registerType('json2csv',{
        category: 'iaCloud dashboard',
        color: '#ffd700',
        defaults: {
            name: {value:""},
            confsel: {value:"defaultSet"},
            complete: {value:"false", required:true},
            fields: {value:""},
            unwind: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "ia-cloud.png",
        label: function() {
            var suffix = "";
            if (this.console === true || this.console === "true") { suffix = " ⇲"; }
            if (this.complete === true || this.complete === "true") {
                return (this.name||"msg") + suffix;
            } else {
                return (this.name || "msg." + ((!this.complete || this.complete === "false") ? "payload" : this.complete)) + suffix;
            }
        }
        
        ,oneditprepare: function() {

            $('input[name="configSel"]:radio').change(function() {
                if ($("#node-input-configSel1").is(":checked")) {
                    $("#node-row-customValueSet").hide();
                    $('#node-input-confsel').val("defaultSet");
                } else {
                    $("#node-row-customValueSet").show();
                    $('#node-input-confsel').val("customSet");
                }
            });
            
            if($("#node-input-confsel").val() == "defaultSet"){
                $('#node-input-configSel1').prop('checked', true);
            } else {
                $('#node-input-configSel2').prop('checked', true);
            }
            $('input[name="configSel"]:radio').change();

            
            $("#node-input-target-complete").typedInput({types:['msg', {value:"full",label:RED._("node-red:debug.msgobj"),hasValue:false}]});
            
            if (this.complete === "true" || this.complete === true) {
                // show complete message object
                $("#node-input-target-complete").typedInput('type','full');
            } else {
                var property = (!this.complete||(this.complete === "false")) ? "payload.Items" : this.complete+"";
                $("#node-input-target-complete").typedInput('type','msg');
                $("#node-input-target-complete").typedInput('value',property);
            }
            $("#node-input-target-complete").on('change',function() {
                if ($("#node-input-target-complete").typedInput('type') === 'msg' &&
                    $("#node-input-target-complete").typedInput('value') === ''
                ) {
                    $("#node-input-target-complete").typedInput('value','payload.Items');
                }
            });
            
        },
        oneditsave: function() {
            var type = $("#node-input-target-complete").typedInput('type');
            if (type === 'full') {
                $("#node-input-complete").val("true");
            } else {
                $("#node-input-complete").val($("#node-input-target-complete").typedInput('value'));
            }
        }
        
    });
</script>

<!-- ノード編集画面テンプレート -->
<script type="text/x-red" data-template-name="json2csv">
    <!-- ノード名 -->
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> ノード名</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <hr>
    <br>

    <!-- 項目設定 -->
    <!--
    <div class="form-row">
        <input type="checkbox" style="display: inline-block; width: auto; vertical-align: top;"
            id="node-input-configSel" checked="checked">
        <label style="width: 40%;" for="node-input-configSel"> デフォルト値利用</label>
    </div>
    -->

    <!-- 項目設定 -->
    <label style="width: 100%;" for="node-input-format" ><i class="fa fa-list"></i>  入力値</label>
    <div class="form-row">
        <input type="text" style="display: none;" id="node-input-confsel" valie="defaultSet">
        <input type="radio" style="display: inline-block; width: auto; vertical-align: top;"
              name="configSel" id="node-input-configSel1"
              value="inchartSet" checked="checked">
        <label style="width: 40%;" for="node-input-configSel1"> デフォルト値使用</label>
        <input type="radio" style="display: inline-block; width: auto; vertical-align: top;"
              name="configSel" id="node-input-configSel2" value="customSet">
        <label style="width: 40%;" for="node-input-configSel2"> カスタム設定</label>
    </div>

    <br>

    <!-- カスタム値の設定 -->
    <div class="form-group hide"  id="node-row-customValueSet" style="width:300px;">
        <!-- 変換先パス -->
        <div class="form-row">
            <label for="node-input-target-complete"><i class="fa fa-list"></i> <span data-i18n="debug.output"></span> 変換先パス</label>
            <input id="node-input-target-complete" type="text" style="width: 70%" placeholder="payload.Items">
            <input id="node-input-complete" type="hidden">
        </div>
        <!-- フィールド名 -->
        <div class="form-row">
            <label for="node-input-fields"><i class="fa fa-list"></i> フィールド名</label>
            <input type="text" id="node-input-fields"
                placeholder="objectKey,timeStamp,dataObject.objectKey,dataObject.objectType,dataObject.objectDescription,
                            dataObject.timeStamp,dataObject.instanceKey,dataObject.ObjectContent.contentType,
                            dataObject.ObjectContent.contentData.dataName,dataObject.ObjectContent.contentData.dataValue,
                            dataObject.ObjectContent.contentData.unit">
        </div>
        <!-- リストパス -->
        <div class="form-row">
            <label for="node-input-unwind"><i class="fa fa-list"></i> リストパス</label>
            <input type="text" id="node-input-unwind" placeholder="dataObject.ObjectContent.contentData">
        </div>
    </div>

    
</script>

<!-- エディタに登録するノード説明 -->
<script type="text/x-red" data-help-name="json2csv">
	<p>json2csv npmモジュールをラップするノードです。
        このノードはjson入力をcsv形式へ変換することができます。</p>
    <h3>入力メッセージ</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>json形式の文字列。</dd>
    </dl>
    <h3>出力メッセージ</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>入力された文字列をcsv形式に変換した結果。</dd>
    </dl>
    <h3>詳細説明</h3>
    <p>変換するデータに応じてプロパティを設定する必要があります。</p>
    <ul>
        <li><code>変換先パス</code> - (文字列)変換を行うJSONのパス</li>
        <li><code>フィールド名</code> - (文字列)CSV出力する際のヘッダー名</li>
        <li><code>リストパス</code> - (文字列)入力値の中にリストが存在する場合は、そのリストのパスを記述</li>
    </ul>
</script>