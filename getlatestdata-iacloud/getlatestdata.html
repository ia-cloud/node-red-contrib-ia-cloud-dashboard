<script type="text/javascript">
    RED.nodes.registerType('getlatestdata',{
        category: "iaCloud dashboard",
        color: "#ffd700",
        defaults: {
			name: {value:""},
			ccsConnectionConfig: { value: '', type: 'ia-cloud-ccs-connection-config', required: true },
			tableName: {value: "", required:true},
			objectKey: {value: "", required:true},
			seriesObject:{value:"", required: true },
			decimalPoint: {value: "noexe"},
			item:{value:"graphData"},
			repeatCheck: {value: ""},
			repeat: {value: "1"},
		},
		credentials: {
		},
        inputs:1,
        outputs:1,
		icon: "ia-cloud.png", 
		paletteLabel: 'getLatestdata',
        label: function() {
            return this.name || "getLatestdata";
        },
        oneditprepare: function () {

			// 項目設定部分の追加・削除ボタン設定
            var frm_cnt = 0;
            //あれば設定データを取り出して、formに展開する。
            var conf = $("#node-input-seriesObject").val();
            if (conf) {
				var dItems = {};
				try { dItems = JSON.parse(conf); }
				catch(e) { conf = "";}
            }
            if(conf != ""){
				//設定データがあった
				var dItems = JSON.parse(conf);
				//フォームを一つ保存
				var original = $('#form_block\\[0\\]');
				//一旦フォームオブジェクトをすべて削除
				$(".form-block[id^='form_block']")
					.each(function(index, formObj) {$(formObj).remove();});
				dItems.forEach(function(value, idx){
					original
					.clone()
					.hide()
					.appendTo("#blocks")
					.attr('id', 'form_block[' + idx + ']') // クローンのid属性を変更。
					.end() // 一度適用する
					.find('div, input, textarea, select, label').each(function(index, obj) {
						if ($(obj).attr('id') != null) {
							if($(obj).attr("id").substr(0,5) == "dItem"){
								$(obj).val("" + (idx + 1));
							}
							$(obj).attr({
							id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
							});
						}
						if ($(obj).attr('name') != null) {
							$(obj).attr({
								name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + idx + ']')
							});
						}
						if ($(obj).attr('for') != null) {
							$(obj).attr({
								for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
							});
						}
					});

					$("#dataName\\[" + idx + "\\]").val(value.dataName);
					$("#displayName\\[" + idx + "\\]").val(value.displayName);

					var block = $('#form_block\\[' + idx + '\\]');
					if (idx != 0) block.find('input[name="del_btn"]').show();
					block.slideDown('slow');
					frm_cnt = idx;
				});
        	}

			//追加ボタンが押されたら
			$("#form_add").off("click");
			$("#form_add").on("click", function() {
				var original = $('#form_block\\[' + frm_cnt + '\\]');
				frm_cnt++;
				original
				.clone()
				.hide()
				.insertAfter(original)
				.attr('id', 'form_block[' + frm_cnt + ']'); // クローンのid属性を変更。
				var clone = $('#form_block\\[' + frm_cnt + '\\]');
				clone.find('div, input, textarea, select, label').each(function(idx, obj) {
					if ($(obj).attr('id') != null) {
						if($(obj).attr("id").substr(0,5) == "dItem"){
							$(obj).val("" + (frm_cnt + 1));
						}
						$(obj).attr({
							id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
						});
						}
						if ($(obj).attr('name') != null) {
						$(obj).attr({
							name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
						});
						}
						if ($(obj).attr('for') != null) {
						$(obj).attr({
							for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
						});
					}
				});
				clone.find('input[name="del_btn"]').show();
				clone.slideDown('fast');
				});

				//削除ボタンが押されたら
				$("#blocks").off('click', 'input[name="del_btn"]');
				$("#blocks").on('click', 'input[name="del_btn"]', function() {
				var removeObj = $(this).parents(".form-block");
				removeObj.fadeOut('fast', function() {
					removeObj.remove();
					// 番号振り直し
					frm_cnt = 0;
					$(".form-block[id^='form_block']").each(function(index, formObj) {
						if ($(formObj).attr('id') != 'form_block[0]') {
							frm_cnt++;
							$(formObj)
							.attr('id', 'form_block[' + frm_cnt + ']') // id属性を変更。
							.find('div, input, textarea, select, label').each(function(idx, obj) {
							if ($(obj).attr('id') != null) {
								if($(obj).attr("id").substr(0,5) == "dItem"){
										$(obj).val("" + (frm_cnt + 1));
								}
								$(obj).attr({
									id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
								});
								}
								if ($(obj).attr('name') != null) {
								$(obj).attr({
									name: $(obj).attr('name').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
								});
								}
								if ($(obj).attr('for') != null) {
								$(obj).attr({
									for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
								});
								}
							});
						}
					});
				});
			});
			
			// 繰り返し設定
			$("#node-input-repeatCheck").change(function() {
                if ($(this).is(":checked")) {
					$(".interval-row").show();
					$("#node-input-repeatCheck").prop("checked", true);
                } else {
					$(".interval-row").hide();
					$("#node-input-repeatCheck").prop("checked", false);
                }
			});
			$(".interval-time-count").spinner({
				//max:60,
				min:1
			});
			$("#node-input-interval-units").change(function() {
				var units = $("#node-input-interval-units option:selected").val();
			});
			var r = "s";
			var c = this.repeat;
			if (this.repeat % 60 === 0) { r = "m"; c = c/60; }
			if (this.repeat % 1440 === 0) { r = "h"; c = c/60; }
			$("#node-input-interval").val(c);
			$("#node-input-interval-units").val(r);
            
        },
        oneditsave: function() {

			// 繰り返し設定
			var repeat = "";
			var count = $("#node-input-interval").val();
			var units = $("#node-input-interval-units").val();
			if (units == "s") {
				repeat = count;
			} else {
				if(units == "m"){
					repeat = count * 60;
				} else if (units ==  "h"){
					repeat = count * 60 * 60;
				}
			}
			$("#node-input-repeat").val(repeat);

			// 項目設定部分の追加・削除ボタン設定
            var dItems = [];
            $(".form-block[id^='form_block']").each(function(idx, obj){
                // var item ={commonName: "Alarm&Event", dataValue: {}, options:{}};
                var item = {};

                item.dataName = $("#dataName\\[" + idx + "\\]").val();
                item.displayName = $("#displayName\\[" + idx + "\\]").val();
                
                dItems[idx]=item;
            });

            //フォームの各要素をobjectに記述し、JSON文字列に変換する。
            try {$("#node-input-seriesObject").val(JSON.stringify(dItems));}
            catch(e) {$("#node-input-seriesObject").val("")}

        }
    });
</script>

<!-- ノード編集画面テンプレート -->
<script type="text/x-red" data-template-name="getlatestdata">
    <!-- ノード名 -->
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="getlatestdata.label.name"></span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <hr/>

	<!-- CCS接続情報 -->
	<div class="form-row">
		<label for="node-input-ccsConnectionConfig"><i class="fa fa-link"></i> <span data-i18n="getlatestdata.label.ccs-connection-config" /></label>
		<input type="text" id="node-input-ccsConnectionConfig" data-i18n="[placeholder]getlatestdata.label.ccs-connection-config">
	</div>

	<hr/>

	<!-- テーブル名 -->
	<div class="form-row">
		<label for="node-input-tableName"><i class="fa fa-tag"></i> <span data-i18n="getlatestdata.label.tableName"></span><span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-tableName" placeholder="tableName"></input>
	</div>

	<!-- オブジェクトキー -->
	<div class="form-row">
		<label for="node-input-objectKey"><i class="fa fa-key"></i> <span data-i18n="getlatestdata.label.objectKey"></span><span style="color: #ff0000;">*</span></label>
		<input type="text" id="node-input-objectKey" placeholder="objectKey"></input>
    </div>

    <!-- 項目名(dataName)と表示名 -->
	<div class="form-row hidden">
		<input type="text" id="node-input-seriesObject">
	</div>
	<div class="form-row">
		<label for="node-input-series"><i class="fa fa-list"></i> <span data-i18n="getlatestdata.label.series"></span><span style="color: #ff0000;">*</span></label>
	</div>
	<div id="blocks" style="margin-left: 10px">
		<div class="form-block" id="form_block[0]">
			<div class="form-row">
				<div class="form-inline" id="from_del[0]" >
					<span data-i18n="getlatestdata.series.number"></span>
					<input type="text" id="dItem[0]" style="width: 30px;" value="1"
						disabled="disabled">
					<input type="button" name="del_btn" data-i18n="[value]getlatestdata.series.delete"
						style="margin-left: 30px; width: 70px; display: none;">
				</div>
			</div>
			<div class="form-row" style="margin-left: 15px">
					<span data-i18n="getlatestdata.series.dataName"></span>：
					<input type="text" style="width:120px;" id="dataName[0]">
					　<span data-i18n="getlatestdata.series.displayName"></span>：
				<input type="text" style="width: 120px;" id="displayName[0]">
			</div>
			<br>
		</div>
	</div>

	<!-- Addボタン -->
	<div class="form-block">
		<input type="button" id="form_add" name="add_btn" data-i18n="[value]getlatestdata.series.add">
	</div>
	<hr/>

	<!-- 繰り返しON/OFF -->
	<div class="form-row">
		<label for="node-input-interval"<i class="fa fa-repeat"></i> <span data-i18n="getlatestdata.label.repeat"></span></label>
		<input type="checkbox" id="node-input-repeatCheck" style="display: inline-block; width: 20px; vertical-align: middle;>
		<label for="node-input-repeatCheck" style="width: 40%; vertical-align: middle;"><span data-i18n="getlatestdata.repeat.check"></label>
	</div>	
	
	<!-- 繰り返し秒数 -->
	<div class="form-row interval-row hide" id="dynamodb-interval-row" style="margin-left: 105px">
        <input id="node-input-interval" value="1" class="interval-time-count"></input>
        <select style="width: 150px" id="node-input-interval-units">
            <option value="s" data-i18n="inject.seconds">Seconds</option>
            <option value="m" data-i18n="inject.minutes">Minutes</option>
            <option value="h" data-i18n="inject.hours">Hours</option>
        </select><br/>
    </div>
    <input type="hidden" id="node-input-repeat">

	<!-- 表示桁数 -->
	<div class="form-row">
		<label for="node-input-decimalPoint"><i class="fa fa-sliders"></i> <span data-i18n="getlatestdata.label.round"></span></label>
		<select type="text" id="node-input-decimalPoint" style="width:120px;">
			<option value="noexe" data-i18n="getlatestdata.round.noexe"></option>
			<option value="3" data-i18n="getlatestdata.round.3"></option>
			<option value="2" data-i18n="getlatestdata.round.2"></option>
			<option value="1" data-i18n="getlatestdata.round.1"></option>
			<option value="0" data-i18n="getlatestdata.round.0"></option>
			<option value="-1" data-i18n="getlatestdata.round.-1"></option>
			<option value="-2" data-i18n="getlatestdata.round.-2"></option>
			<option value="-3" data-i18n="getlatestdata.round.-3"></option>
		</select>
	</div>
    
    <!-- 表示項目 -->
    <div class="form-row">
        <label for="node-input-item"><i class="fa fa-bars"></i> <span data-i18n="getlatestdata.label.item"></span></label>
        <select type="text" style="width:250px;" id="node-input-item">
            <option value="graphData" data-i18n="getlatestdata.item.graphData"></option>
            <option value="numericData" data-i18n="getlatestdata.item.numericData"></option>
        </select>
    </div>
</script>

<style>
    .interval-row {
    }
    .interval-time-row select {
        margin: 3px 0;
    }
    .interval-row > .ui-spinner {
        height: 28px;
        margin: 3px 0;
        border-color: rgb(204, 204, 204);
    }
    .interval-time-count {
        width: 40px !important;
    }
</style>